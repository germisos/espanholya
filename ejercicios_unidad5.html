<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ejercicios Unidad 5 ‚Äì Verbos con cambio voc√°lico</title>
<script src="menu.js" defer></script>  
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f9;
        color: #333;
    }

    /* Contenedor principal para centrar el contenido */
    .lesson-container {
        max-width: 900px;
        margin: 80px auto 25px auto;
        padding: 25px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 6px 15px rgba(0,0,0,0.15);
    }

    h2, h3 {
        color: #007bff;
        border-bottom: 2px solid #007bff;
        padding-bottom: 4px;
    }

    /* Estilos para las listas de ejercicios */
    .exercise-list {
        list-style: none;
        padding: 0;
    }

    .exercise-list li {
        margin: 15px 0;
        display: flex;
        align-items: center;
        gap: 15px; /* Espacio entre la frase y los botones */
    }

    p.explanation {
        font-style: italic;
        color: #555;
        margin-bottom: 15px;
    }

    hr {
        margin: 30px 0;
        border: none;
        border-top: 2px solid #ddd;
    }

    /* Botones de audio (O√≠r - AZUL) */
    .play-button, .audio-btn { 
        border: none;
        border-radius: 5px;
        padding: 8px 12px;
        cursor: pointer;
        color: white;
        font-weight: bold;
        background-color: #007bff; /* Azul */
        font-size: 1em;
    }
    .play-button:hover, .audio-btn:hover {
        background-color: #0056b3; /* Azul m√°s oscuro */
    }

    /* Bot√≥n de Micr√≥fono (Grabar - VERDE) */
    .mic-button {
        background-color: #28a745; /* Verde */
        border: none;
        border-radius: 5px;
        padding: 8px 12px;
        cursor: pointer;
        color: white;
        font-weight: bold;
        font-size: 1em;
    }
    .mic-button:hover {
        background-color: #218838; /* Verde m√°s oscuro */
    }

    /* Retroalimentaci√≥n de voz */
    .feedback {
        font-size: 0.9em;
        margin-left: 6px;
        flex-grow: 1; /* Permite que el feedback ocupe el espacio restante */
    }

    .feedback.ok {
        color: green;
        font-weight: bold;
    }
    .feedback.retry {
        color: red;
    }
</style>
</head>

<body>

<div class="lesson-container">

    <h2>EJERCICIOS UNIDAD 5 ‚Äì VERBOS CON CAMBIO VOC√ÅLICO</h2>

    <p class="explanation">En los siguientes ejercicios, haz clic en **O√≠r** (azul) para escuchar la frase. Luego, haz clic en **üé§ Grabar** (verde) y repite la frase. El sistema te dar√° una retroalimentaci√≥n sobre tu pronunciaci√≥n.</p>

    <section class="exercise-section">
        <h3>EJERCICIO 1: Escucha y Repite (Introducci√≥n)</h3>

        <ol class="exercise-list">
            <li>
                Ellos no pueden ir al cine.
                <button class="play-button" data-text="Ellos no pueden ir al cine" data-audio="assets/audio/unidad5/ejercicios/e1-1.mp3">O√≠r</button>
                <button class="mic-button">üé§ Grabar</button>
                <span class="feedback"></span>
            </li>
            <li>
                ¬øT√∫ quieres un caf√© o prefieres t√©?
                <button class="play-button" data-text="T√∫ quieres un caf√© o prefieres t√©" data-audio="assets/audio/unidad5/ejercicios/e1-2.mp3">O√≠r</button>
                <button class="mic-button">üé§ Grabar</button>
                <span class="feedback"></span>
            </li>
            <li>
                Nosotras cerramos la tienda a las nueve.
                <button class="play-button" data-text="Nosotras cerramos la tienda a las nueve" data-audio="assets/audio/unidad5/ejercicios/e1-3.mp3">O√≠r</button>
                <button class="mic-button">üé§ Grabar</button>
                <span class="feedback"></span>
            </li>
            <li>
                Mi hermano duerme mucho los domingos.
                <button class="play-button" data-text="Mi hermano duerme mucho los domingos" data-audio="assets/audio/unidad5/ejercicios/e1-4.mp3">O√≠r</button>
                <button class="mic-button">üé§ Grabar</button>
                <span class="feedback"></span>
            </li>
            <li>
                (Ustedes) ¬øPueden llamarnos m√°s tarde?
                <button class="play-button" data-text="Pueden llamarnos m√°s tarde" data-audio="assets/audio/unidad5/ejercicios/e1-5.mp3">O√≠r</button>
                <button class="mic-button">üé§ Grabar</button>
                <span class="feedback"></span>
            </li>
        </ol>
    </section>

    <hr>

    <section class="exercise-section">
        <h3>EJERCICIO 2: Escucha y Repite (Verbos E ‚Üí IE)</h3>

        <p class="explanation">Practica la diptongaci√≥n E ‚Üí IE de los verbos **CERRAR**, **QUERER** y **PREFERIR**.</p>

        <ol class="exercise-list">
            <li>
                T√∫ cierras la puerta de la sala.
                <button class="play-button" data-text="T√∫ cierras la puerta de la sala" data-audio="assets/audio/unidad5/ejercicios/e2-1.mp3">O√≠r</button>
                <button class="mic-button">üé§ Grabar</button>
                <span class="feedback"></span>
            </li>
            <li>
                √âl quiere irse a las seis.
                <button class="play-button" data-text="√âl quiere irse a las seis" data-audio="assets/audio/unidad5/ejercicios/e2-2.mp3">O√≠r</button>
                <button class="mic-button">üé§ Grabar</button>
                <span class="feedback"></span>
            </li>
            <li>
                (Ustedes) Prefieren el t√© verde.
                <button class="play-button" data-text="Prefieren el t√© verde" data-audio="assets/audio/unidad5/ejercicios/e2-3.mp3">O√≠r</button>
                <button class="mic-button">üé§ Grabar</button>
                <span class="feedback"></span>
            </li>
            <li>
                Yo prefiero quedarme en casa.
                <button class="play-button" data-text="Yo prefiero quedarme en casa" data-audio="assets/audio/unidad5/ejercicios/e2-4.mp3">O√≠r</button>
                <button class="mic-button">üé§ Grabar</button>
                <span class="feedback"></span>
            </li>
            <li>
                Nosotros cerramos la boca.
                <button class="play-button" data-text="Nosotros cerramos la boca" data-audio="assets/audio/unidad5/ejercicios/e2-5.mp3">O√≠r</button>
                <button class="mic-button">üé§ Grabar</button>
                <span class="feedback"></span>
            </li>
        </ol>
    </section>

    <hr>

    <section class="exercise-section">
        <h3>EJERCICIO 3: Escucha y Repite (Verbos O‚ÜíUE y E‚ÜíIE)</h3>

        <p class="explanation">Practica frases que mezclan verbos con diptongaci√≥n, como **PODER** y **DORMIR** (O‚ÜíUE) con **QUERER** y **CERRAR** (E‚ÜíIE).</p>

        <ol class="exercise-list">
            <li>
                Yo no puedo, pero t√∫ puedes ayudar.
                <button class="play-button" data-text="Yo no puedo, pero t√∫ puedes ayudar" data-audio="assets/audio/unidad5/ejercicios/e3-1.mp3">O√≠r</button>
                <button class="mic-button">üé§ Grabar</button>
                <span class="feedback"></span>
            </li>
            <li>
                Ellos no duermen si no quieren.
                <button class="play-button" data-text="Ellos no duermen si no quieren" data-audio="assets/audio/unidad5/ejercicios/e3-2.mp3">O√≠r</button>
                <button class="mic-button">üé§ Grabar</button>
                <span class="feedback"></span>
            </li>
            <li>
                ¬øVosotros pod√©is preferir otra opci√≥n?
                <button class="play-button" data-text="Vosotros pod√©is preferir otra opci√≥n" data-audio="assets/audio/unidad5/ejercicios/e3-3.mp3">O√≠r</button>
                <button class="mic-button">üé§ Grabar</button>
                <span class="feedback"></span>
            </li>
            <li>
                Yo cierro la puerta y me duermo.
                <button class="play-button" data-text="Yo cierro la puerta y me duermo" data-audio="assets/audio/unidad5/ejercicios/e3-4.mp3">O√≠r</button>
                <button class="mic-button">üé§ Grabar</button>
                <span class="feedback"></span>
            </li>
            <li>
                ¬øPor qu√© √©l no quiere ir a dormir?
                <button class="play-button" data-text="Por qu√© √©l no quiere ir a dormir" data-audio="assets/audio/unidad5/ejercicios/e3-5.mp3">O√≠r</button>
                <button class="mic-button">üé§ Grabar</button>
                <span class="feedback"></span>
            </li>
        </ol>
    </section>

    <hr>

</div>

<script>
    // 1. Funci√≥n gen√©rica para reproducir cualquier URL de audio
    function playAudio(src) {
        const audio = new Audio(src);
        audio.play().catch(error => {
            console.error("‚ùå Error de reproducci√≥n de audio. Comprueba la ruta:", src, error);
            alert("No se pudo reproducir el audio. Verifica la ruta del archivo y la consola (F12).");
        });
    }

    // 2. Escuchadores para los botones de audio y micro
    
    // Configuraci√≥n del Reconocimiento de Voz
    // Se usa el prefijo webkit para mayor compatibilidad con navegadores Chromium
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'es-ES'; // Idioma espa√±ol
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    // Listener unificado para todos los botones de audio (O√≠r)
    document.querySelectorAll('.play-button, .audio-btn').forEach(btn => {
        const audioSrc = btn.dataset.audio;
        if (audioSrc) {
            btn.addEventListener('click', () => {
                playAudio(audioSrc);
            });
        }
    });

    // Listener para los botones de micr√≥fono (Grabar)
    document.querySelectorAll('.mic-button').forEach(micBtn => {
        micBtn.addEventListener('click', () => {
            const parent = micBtn.closest('li');
            const playBtn = parent.querySelector('.play-button');
            
            // Texto que el alumno debe decir (se obtiene del bot√≥n O√≠r)
            let expectedText = playBtn ? playBtn.dataset.text : '';
            expectedText = expectedText.toLowerCase().trim().replace(/[¬ø?¬°!]/g, ''); // Limpieza de signos
            
            const feedback = parent.querySelector('.feedback');
            
            if (!expectedText) {
                feedback.textContent = "‚ö†Ô∏è Error: Falta el texto esperado para verificar.";
                feedback.className = "feedback retry";
                return;
            }
            
            feedback.textContent = "üéôÔ∏è Escuchando... Habla ahora.";
            feedback.className = "feedback";
            micBtn.disabled = true;

            recognition.start();

            recognition.onresult = (event) => {
                const said = event.results[0][0].transcript.toLowerCase().trim().replace(/[¬ø?¬°!]/g, '');
                
                // Funci√≥n de verificaci√≥n de palabras clave (70% de coincidencia)
                const expectedWords = expectedText.split(/\s+/);
                const saidWords = said.split(/\s+/);
                
                const commonWords = saidWords.filter(word => expectedWords.includes(word)).length;
                const matchRatio = commonWords / expectedWords.length;
                
                // Criterio de √©xito: al menos el 70% de las palabras clave deben coincidir.
                const isCorrect = matchRatio >= 0.7; 

                if (isCorrect) {
                    feedback.textContent = "‚úÖ ¬°Bien! Dijiste: '" + said + "'";
                    feedback.className = "feedback ok";
                } else {
                    feedback.textContent = "üîÅ Cerca: Dijiste: '" + said + "'. Intenta de nuevo. (Necesitas: '" + expectedText + "')";
                    feedback.className = "feedback retry";
                }
            };
            
            // Al finalizar la escucha, habilita el bot√≥n.
            recognition.onend = () => {
                micBtn.disabled = false;
                if(feedback.textContent.includes('Escuchando')) {
                    // Si termina sin resultado (timeout, no-speech, etc.)
                    feedback.textContent = "‚ö†Ô∏è No se detect√≥ voz. Intenta de nuevo.";
                    feedback.className = "feedback retry";
                }
            };

            recognition.onerror = (event) => {
                let errorMsg = "‚ö†Ô∏è Error: El micr√≥fono no funciona o el navegador no lo soporta.";
                if (event.error === 'not-allowed') {
                    errorMsg = "‚ö†Ô∏è Acceso denegado: Debes permitir el uso del micr√≥fono en la configuraci√≥n del navegador.";
                } else if (event.error === 'no-speech') {
                    errorMsg = "‚ö†Ô∏è No se detect√≥ voz. Intenta de nuevo.";
                }
                feedback.textContent = errorMsg;
                feedback.className = "feedback retry";
                micBtn.disabled = false;
                console.error("Speech Recognition Error:", event.error);
            };
        });
    });
</script>

</body>
</html>
