<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Criar Conta</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      width: 300px;
      text-align: center;
    }
    input {
      display: block;
      width: 100%;
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      width: 100%;
      background: #007bff;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover:not(:disabled) {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .message {
      margin-top: 15px;
      padding: 10px;
      border-radius: 5px;
    }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background: #cce5ff; color: #004085; border: 1px solid #b8daff; }
  </style>
</head>
<body>
  <div class="container">
    <h2 id="formTitle">Criar conta</h2>
    <div id="accessMessage" class="message info">Verificando status de pagamento...</div>
    
    <form id="registroForm" style="display:none;">
      <input type="email" id="email" placeholder="E-mail" required>
      <input type="password" id="password" placeholder="Senha" required>
      <button type="submit" id="submitButton">Registrar</button>
      <p style="margin-top: 15px;">Já tem conta? <a href="login.html">Entrar</a></p>
    </form>
  </div>

  <script src="menu.js" defer></script>
  <script type="module">
    // Imports para Autenticação e Firestore
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // Variáveis Globais (MANDATÓRIO USAR)
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Inicialização
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const registroForm = document.getElementById("registroForm");
    const accessMessage = document.getElementById("accessMessage");
    const submitButton = document.getElementById("submitButton");

    // -----------------------------------------------------------
    // 1. VERIFICAÇÃO DO STATUS DE PAGAMENTO DO MERCADO PAGO
    // -----------------------------------------------------------
    const urlParams = new URLSearchParams(window.location.search);
    const collectionStatus = urlParams.get('collection_status');

    let hasPaid = false;
    
    if (collectionStatus === 'approved') {
      hasPaid = true;
      accessMessage.textContent = "✅ Pagamento Aprovado! Por favor, crie sua conta para acessar o curso.";
      accessMessage.classList.replace('info', 'success');
      registroForm.style.display = 'block';
    } else {
      accessMessage.textContent = "❌ Não encontramos um pagamento aprovado. Por favor, pague antes de se registrar.";
      accessMessage.classList.replace('info', 'error');
      // Remove o formulário e sugere pagar
      registroForm.style.display = 'none';
      const payLink = document.createElement('p');
      payLink.innerHTML = '<a href="pago.html" style="color:#007bff; font-weight: bold;">Clique aqui para pagar.</a>';
      document.querySelector('.container').appendChild(payLink);
    }


    // -----------------------------------------------------------
    // 2. LÓGICA DE REGISTRO E SALVAMENTO NO FIRESTORE
    // -----------------------------------------------------------
    registroForm.addEventListener("submit", (e) => {
      e.preventDefault();
      
      if (!hasPaid) {
        // Usamos um modal ou mensagem em vez de alert()
        accessMessage.textContent = "Erro: O registro só é permitido após o pagamento aprovado.";
        accessMessage.classList.replace('success', 'error');
        return;
      }

      submitButton.disabled = true;
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      createUserWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          const userId = user.uid;

          // Salva o status de acesso no Firestore (MANDATÓRIO para aplicativos multiusuário)
          const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
          
          return setDoc(userDocRef, {
            email: user.email,
            hasAccess: true, // Flag de acesso concedido
            registrationDate: new Date().toISOString(),
          });
        })
        .then(() => {
          accessMessage.textContent = "Conta criada com sucesso e acesso garantido! Redirecionando para login...";
          setTimeout(() => {
            window.location.href = "login.html";
          }, 2000);
        })
        .catch((error) => {
          console.error("Erro no Registro:", error.message);
          accessMessage.textContent = "❌ Erro ao registrar: " + error.message;
          accessMessage.classList.replace('success', 'error');
        })
        .finally(() => {
          submitButton.disabled = false;
        });
    });
  </script>
</body>
</html>
